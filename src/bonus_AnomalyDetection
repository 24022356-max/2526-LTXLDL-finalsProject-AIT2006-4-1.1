import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

INPUT_FILE = 'processed'
OUTPUT_FILE = 'reports'
df = pd.read_csv(INPUT_FILE)

full_range = pd.date_range(start='2019-01-01', end='2019-12-31 23:00:00', freq='H')
df_full = pd.DataFrame({'datetime_idx': full_range})

df['revenue_per_mile'] = df['total_money'] / df['distance_sum']  
df['revenue_per_mile'] = df['revenue_per_mile'].replace([np.inf, -np.inf], np.nan).fillna(0)

def calculate_zscore(series):
    std = series.std()
    if std == 0:
        return 0
    return (series - series.mean()) / std

groups = df.groupby(['dow', 'hour'])

df['z_trips'] = groups['trips'].transform(calculate_zscore)
df['z_speed'] = groups['speed_mean'].transform(calculate_zscore)
df['z_rev_mile'] = groups['revenue_per_mile'].transform(calculate_zscore)

THRESHOLD = 3

# Rule 1: Volume Shock
df['anomaly_volume'] = np.abs(df['z_trips']) > THRESHOLD

# Rule 2: Congestion Shock
df['anomaly_congestion'] = df['z_speed'] < -THRESHOLD

# Rule 3: Price Shock
df['anomaly_price'] = df['z_rev_mile'] > THRESHOLD

# add reason
def categorize_anomaly(row):
    reasons = []
    if row['anomaly_volume']:
        if row['z_trips'] > 0: reasons.append('High Demand')
        else: reasons.append('Low Demand')
    if row['anomaly_congestion']: reasons.append('Traffic Jam')
    if row['anomaly_price']: reasons.append('High Price Rate')
    
    if not reasons: return 'Normal'
    return ', '.join(reasons)


df['anomaly_type'] = df.apply(categorize_anomaly, axis=1)

anomalies_df = df[df['anomaly_type'] != 'Normal'].copy()
anomalies_df = anomalies_df.sort_values(by='z_trips', ascending=True)

cols_to_export = [
    'date', 'day', 'hour',           
    'trips', 'speed_mean',           
    'revenue_per_mile',              
    'z_trips', 'z_speed', 'z_rev_mile', 
    'anomaly_type'                  
]

existing_cols = [c for c in cols_to_export if c in anomalies_df.columns]
final_output = anomalies_df[existing_cols]

final_output.to_csv(OUTPUT_FILE, index=False)
